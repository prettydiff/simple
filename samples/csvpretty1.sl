// A small CSV parser rewritten from //
// JavaScript into SL //

/*original JS code at */
/*http://prettydiff.com/lib/csvpretty.js*/

//TODO//
//1 - I need to define a module system. //
// "options" is externally defined and //
// would be included into this file//
l
e
t
(
    c
    s
    v
    p
    r
    e
    t
    t
    y
    :
    (
        o
        p
        t
        i
        o
        n
        s
        : "hash"
    )
    {
        l
        e
        t
        (
            t
            o
            k
            e
            n
            :
            S
            t
            o
            r
            e
            [
                "array"
            ]
            ,
            t
            o
            k
            e
            n
            i
            z
            e
            :
            (
            )
            {
                l
                e
                t
                (
                    i
                    n
                    p
                    u
                    t
                    :
                    o
                    p
                    t
                    i
                    o
                    n
                    s
                    [
                        "source"
                    ]
                    [
                        "split"
                    ]
                    (
                        ""
                    )
                    ,
                    d
                    :
                    o
                    p
                    t
                    i
                    o
                    n
                    s
                    [
                        "csvchar"
                    ]
                    [
                        "length"
                    ]
                    ,
                    e
                    :
                    0
                    ,
                    c
                    e
                    l
                    l
                    :
                    S
                    t
                    o
                    r
                    e
                    [
                        "array"
                    ]
                    ,
                    r
                    o
                    w
                    :
                    S
                    t
                    o
                    r
                    e
                    [
                        "array"
                    ]
                    ,
                    q
                    u
                    o
                    t
                    e
                    :
                    f
                    a
                    l
                    s
                    e,
                    c
                    e
                    l
                    l
                    C
                    r
                    u
                    n
                    c
                    h
                    :
                    (
                    )
                    {
                        l
                        e
                        t
                        (
                            s
                            t
                            r
                            :
                            c
                            e
                            l
                            l
                            [
                                "join"
                            ]
                            (
                                ""
                            )
                        )
                        ;
                        c
                        e
                        l
                        l
                        :
                        S
                        t
                        o
                        r
                        e
                        [
                            "array"
                        ]
                        ;
                        i
                        f
                        (
                            s
                            t
                            r
                            ~
                            ""
                        )
                        {
                            r
                            o
                            w
                            [
                                "push"
                            ]
                            (
                                s
                                t
                                r
                            )
                            ;
                        }
                    }
                    ,
                    p
                    a
                    r
                    s
                    e
                    :
                    (
                        i
                        t
                        e
                        m
                        :
                        "string"
                        ,
                        i
                        n
                        d
                        e
                        x
                        :
                        "number"
                        ,
                        a
                        r
                        r
                        :
                        "array"
                    )
                    {
                        l
                        e
                        t
                        (
                            q
                            u
                            o
                            t
                            e
                            F
                            a
                            l
                            s
                            e
                            :
                            {
                                i
                                f
                                (
                                    c
                                    e
                                    l
                                    l
                                    [
                                        "length"
                                    ]
                                    =
                                    0
                                    &
                                    i
                                    t
                                    e
                                    m
                                    =
                                    "\""
                                    &
                                    (
                                        a
                                        r
                                        r
                                        [
                                            i
                                            n
                                            d
                                            e
                                            x
                                            +
                                            1
                                        ]
                                        ~
                                        "\""
                                        |
                                        a
                                        r
                                        r
                                        [
                                            i
                                            n
                                            d
                                            e
                                            x
                                            +
                                            2
                                        ]
                                        =
                                        "\""
                                    )
                                )
                                {
                                    q
                                    u
                                    o
                                    t
                                    e
                                    :
                                    t
                                    r
                                    u
                                    e
                                    ;
                                }
                                e
                                l
                                s
                                e
                                i
                                f
                                (
                                    i
                                    t
                                    e
                                    m
                                    =
                                    "\""
                                    &
                                    a
                                    r
                                    r
                                    [
                                        i
                                        n
                                        d
                                        e
                                        x
                                        +
                                        1
                                    ]
                                    =
                                    "\""
                                )
                                {
                                    c
                                    e
                                    l
                                    l
                                    [
                                        "push"
                                    ]
                                    (
                                        "\""
                                    )
                                    ;
                                    a
                                    r
                                    r
                                    [
                                        i
                                        n
                                        d
                                        e
                                        x
                                        +
                                        1
                                    ]
                                    :
                                    ""
                                    ;
                                }
                                e
                                l
                                s
                                e
                                i
                                f
                                (
                                    i
                                    t
                                    e
                                    m
                                    =
                                    "\n"
                                )
                                {
                                    c
                                    e
                                    l
                                    l
                                    C
                                    r
                                    u
                                    n
                                    c
                                    h
                                    (
                                    )
                                    ;
                                    t
                                    o
                                    k
                                    e
                                    n
                                    [
                                        "push"
                                    ]
                                    (
                                        r
                                        o
                                        w
                                    )
                                    ;
                                    r
                                    o
                                    w
                                    :
                                    S
                                    t
                                    o
                                    r
                                    e
                                    [
                                        "array"
                                    ]
                                    ;
                                }
                                e
                                l
                                s
                                e
                                i
                                f
                                (
                                    i
                                    t
                                    e
                                    m
                                    =
                                    o
                                    p
                                    t
                                    i
                                    o
                                    n
                                    s
                                    [
                                        "csvchar"
                                    ]
                                    [
                                        "charAt"
                                    ]
                                    (
                                        0
                                    )
                                )
                                {
                                    i
                                    f
                                    (
                                        d
                                        =
                                        1
                                    )
                                    {
                                        c
                                        e
                                        l
                                        l
                                        C
                                        r
                                        u
                                        n
                                        c
                                        h
                                        (
                                        )
                                        ;
                                    }
                                    e
                                    l
                                    s
                                    e
                                    {
                                        e
                                        :
                                        0
                                        ;
                                        d
                                        o
                                        {
                                            e
                                            :
                                            +
                                            1
                                            ;
                                        }
                                        u
                                        n
                                        t
                                        i
                                        l
                                        (
                                            e
                                            =
                                            d
                                            |
                                            a
                                            r
                                            r
                                            [
                                                i
                                                n
                                                d
                                                e
                                                x
                                                +
                                                e
                                            ]
                                            =
                                            o
                                            p
                                            t
                                            i
                                            o
                                            n
                                            s
                                            [
                                                "csvchar"
                                            ]
                                            [
                                                "charAt"
                                            ]
                                            (
                                                e
                                            )
                                        )
                                        ;
                                        i
                                        f
                                        (
                                            e
                                            =
                                            d
                                        )
                                        {
                                            c
                                            e
                                            l
                                            l
                                            C
                                            r
                                            u
                                            n
                                            c
                                            h
                                            (
                                            )
                                            ;
                                            e
                                            :
                                            1
                                            ;
                                            d
                                            o
                                            {
                                                a
                                                r
                                                r
                                                [
                                                    i
                                                    n
                                                    d
                                                    e
                                                    x
                                                    +
                                                    e
                                                ]
                                                :
                                                ""
                                                ;
                                                e
                                                :
                                                +
                                                1
                                                ;
                                            }
                                            u
                                            n
                                            t
                                            i
                                            l
                                            (
                                                e
                                                =
                                                d
                                            )
                                            ;
                                        }
                                        e
                                        l
                                        s
                                        e
                                        i
                                        f
                                        (
                                            i
                                            t
                                            e
                                            m
                                            ~
                                            ""
                                        )
                                        {
                                            c
                                            e
                                            l
                                            l
                                            [
                                                "push"
                                            ]
                                            (
                                                i
                                                t
                                                e
                                                m
                                            )
                                            ;
                                        }
                                    }
                                }
                                e
                                l
                                s
                                e
                                i
                                f
                                (
                                    i
                                    t
                                    e
                                    m
                                    ~
                                    ""
                                )
                                {
                                    c
                                    e
                                    l
                                    l
                                    [
                                        "push"
                                    ]
                                    (
                                        i
                                        t
                                        e
                                        m
                                    )
                                    ;
                                }
                            }
                        )
                        ;
                        i
                        f
                        (
                            q
                            u
                            o
                            t
                            e
                            =
                            f
                            a
                            l
                            s
                            e
                        )
                        q
                        u
                        o
                        t
                        e
                        F
                        a
                        l
                        s
                        e
                        (
                        )
                        ;
                        e
                        l
                        s
                        e
                        i
                        f
                        (
                            i
                            t
                            e
                            m
                            ~
                            "\""
                            &
                            i
                            t
                            e
                            m
                            ~
                            ""
                        )
                        {
                            c
                            e
                            l
                            l
                            [
                                "push"
                            ]
                            (
                                i
                                t
                                e
                                m
                            )
                            ;
                        }
                        e
                        l
                        s
                        e
                        i
                        f
                        (
                            i
                            t
                            e
                            m
                            =
                            "\""
                            &
                            a
                            r
                            r
                            [
                                i
                                n
                                d
                                e
                                x
                                +
                                1
                            ]
                            =
                            "\""
                            )
                            {
                                c
                                e
                                l
                                l
                                [
                                    "push"
                                ]
                                (
                                    "\""
                                )
                                ;
                                a
                                r
                                r
                                [
                                    i
                                    n
                                    d
                                    e
                                    x
                                    +
                                    1
                                ]
                                :
                                ""
                                ;
                            }
                            e
                            l
                            s
                            e
                            i
                            f
                            (
                                i
                                t
                                e
                                m
                                =
                                "\""
                            )
                            {
                                c
                                e
                                l
                                l
                                C
                                r
                                u
                                n
                                c
                                h
                                (
                                )
                                ;
                                q
                                u
                                o
                                t
                                e
                                :
                                f
                                a
                                l
                                s
                                e
                                ;
                            }
                        }
                    )
                    ;
                    i
                    n
                    p
                    u
                    t
                    [
                        "forEach"
                    ]
                    (
                        p
                        a
                        r
                        s
                        e
                    )
                    ;
                    i
                    f
                    (
                        c
                        e
                        l
                        l
                        [
                            "length"
                        ]
                        >
                        0
                    )
                    {
                    c
                    e
                    l
                    l
                    C
                    r
                    u
                    n
                    c
                    h
                    (
                    )
                    ;
                    t
                    o
                    k
                    e
                    n
                    [
                        "push"
                    ]
                    (
                        r
                        o
                        w
                    )
                    ;
                }
            }
        )
        ;
        o
        p
        t
        i
        o
        n
        s
        [
            "csvchar"
        ]
        :
        (
            o
            p
            t
            i
            o
            n
            s
            [
                "csvchar"
            ]
            [
                "type"
            ]
            =
            "string"
        )
            ?
            o
            p
            t
            i
            o
            n
            s
            [
                "csvchar"
            ]
            #
            ","
            ;
        o
        p
        t
        i
        o
        n
        s
        [
            "source"
        ]
        :
        (
            o
            p
            t
            i
            o
            n
            s
            [
                "source"
            ]
            [
                "type"
            ]
            ~
            "string"
            |
            o
            p
            t
            i
            o
            n
            s
            [
                "source"
            ]
            =
            ""
            |
            `^(\s+)$`
            [
                "test"
            ]
            (
                o
                p
                t
                i
                o
                n
                s
                [
                    "source"
                ]
            )
            =
            t
            r
            u
            e
        )
            ?
            "Error: no source supplied to csvpretty."
            #
            o
            p
            t
            i
            o
            n
            s
            [
                "source"
            ]
            [
                "replace"
            ]
            (
                `\r\n`
                g
                ,
                "\n"
            )
            [
                "replace"
            ]
            (
                `\r`
                g
                ,
                "\n"
            )
            ;
            t
            o
            k
            e
            n
            i
            z
            e
            (
            )
            ;
        r
        e
        t
        u
        r
        n
        (
            t
            o
            k
            e
            n
        );
    }
);
c
s
v
p
r
e
t
t
y
(
    o
    p
    t
    i
    o
    n
    s
)
;
